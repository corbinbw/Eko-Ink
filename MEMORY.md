# EkoInk App - Development Memory

## Project Overview
EkoInk is a handwritten thank you note automation system for car dealerships. Sales representatives submit deal information via a public form, and the system generates personalized AI-powered thank you notes that can be sent as handwritten cards.

## Current Status (Updated: October 15, 2025)

### ‚úÖ Working Features
1. **Authentication System**
   - Email/password authentication via Supabase Auth
   - Login page at `/login`
   - Protected dashboard routes with middleware
   - User: corbinbrandonwilliams@gmail.com (password: password123)

2. **Public Deal Submission Form** (`/submit`)
   - Collects customer information (name, product, deal value, personal details)
   - Optional audio call recording (MP3 upload or URL)
   - Creates deal, call, and note records in one transaction
   - Publicly accessible (no auth required)

3. **Dashboard** (`/dashboard`)
   - Shows recent deals
   - Navigation to view all notes

4. **Notes Management** (`/dashboard/notes`)
   - Server component with proper authentication
   - Lists all notes for the logged-in user
   - Shows note status (pending, draft, approved, sent)
   - Generate Note button for pending notes
   - Review & Approve button for draft notes

5. **AI Note Generation** (`/api/notes/[noteId]/generate`)
   - **Transcription**: Uses AssemblyAI to transcribe call audio (if provided)
   - **Key Moments**: Extracts important moments from transcript
   - **AI Writing**: Uses Anthropic Claude (claude-3-haiku-20240307) to generate personalized thank you notes
   - Notes are 60-80 words, warm/genuine tone, reference specific details
   - Updates note status to 'draft' after generation

### üîß Technical Stack
- **Framework**: Next.js 15.5.5 (App Router)
- **Database**: Supabase (PostgreSQL)
- **Authentication**: Supabase Auth
- **AI Services**:
  - Anthropic Claude API (claude-3-haiku-20240307) - for note generation
  - AssemblyAI - for audio transcription
- **Styling**: Tailwind CSS
- **File Storage**: Supabase Storage (call-audio bucket)

### üìÅ Key Files

#### API Routes
- `/app/api/deals/route.ts` - Create deals, calls, and notes from public form submissions
- `/app/api/notes/route.ts` - Fetch notes with authentication
- `/app/api/notes/[noteId]/generate/route.ts` - Generate AI thank you notes from call data

#### Pages
- `/app/login/page.tsx` - Login page
- `/app/submit/page.tsx` - Public deal submission form
- `/app/dashboard/page.tsx` - Main dashboard
- `/app/dashboard/notes/page.tsx` - Notes list (server component)
- `/app/dashboard/notes/GenerateNoteButton.tsx` - Client component for generate button

#### Configuration
- `/lib/supabase/server.ts` - Supabase server client utilities
  - `createClient()` - Regular client with user auth
  - `createServiceClient()` - Service role client (bypasses RLS)
- `/middleware.ts` - Route protection for dashboard
- `/.env.local` - Environment variables (see below)

### üîë Environment Variables
```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://vszhsjpmlufjmmbswvov.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# OpenAI (currently not in use - switched to Anthropic)
OPENAI_API_KEY=sk-proj-4EOFCLz7YOfmldLrGNqWTsD...

# Anthropic (ACTIVE)
ANTHROPIC_API_KEY=sk-ant-api03-[REDACTED]

# AssemblyAI
ASSEMBLYAI_API_KEY=d2fecc53765a4dc2808f83a0081fd3e7
```

### üóÑÔ∏è Database Schema

#### Tables
1. **users** (Supabase Auth managed)
   - Standard Supabase auth.users table

2. **deals**
   - `id` (uuid, primary key)
   - `user_id` (uuid, references auth.users)
   - `customer_first_name`, `customer_last_name`
   - `customer_email`, `customer_phone`
   - `product_name`
   - `deal_value` (numeric)
   - `personal_detail` (text)
   - `created_at`

3. **calls**
   - `id` (uuid, primary key)
   - `user_id` (uuid, references auth.users)
   - `mp3_url` (text) - Direct URL to MP3
   - `mp3_storage_path` (text) - Path in Supabase storage
   - `transcript` (text) - Generated by AssemblyAI
   - `key_moments` (text) - Extracted important moments
   - `transcript_status` (text: pending/processing/complete/failed)
   - `transcribed_at` (timestamp)
   - `created_at`

4. **notes**
   - `id` (uuid, primary key)
   - `user_id` (uuid, references auth.users)
   - `deal_id` (uuid, references deals)
   - `call_id` (uuid, references calls, nullable)
   - `draft_text` (text) - AI-generated draft
   - `final_text` (text) - Approved version
   - `status` (text: pending/draft/approved/sent/failed)
   - `requires_approval` (boolean, default: true)
   - `approved_at`, `sent_at`
   - `created_at`, `updated_at`

#### RLS Policies
- All tables have RLS enabled
- Users can only access their own data
- Public insert on deals/calls/notes for the submission form (sets user_id from form data)

### üöÄ Recent Changes (This Session)

#### Password Authentication Added
- Switched from magic links to password authentication
- Created script to add password to existing user: `/scripts/add-password.js`
- User corbinbrandonwilliams@gmail.com now has password: password123

#### Fixed Authentication Issues
- Refactored `/dashboard/notes/page.tsx` from client to server component
- Fixed logout issues when clicking navigation
- Created separate client component for Generate button

#### Fixed Note Display Logic
- Updated `/app/api/deals/route.ts` to set `status: 'pending'` instead of 'draft' for new notes
- Fixed conditional logic to show Generate button for empty/pending notes
- Notes without content now show "Note content not yet generated" message

#### Switched from OpenAI to Anthropic
- OpenAI API quota was exceeded
- Integrated Anthropic Claude API for note generation
- Using model: `claude-3-haiku-20240307`
- User added $10 in Anthropic API credits
- Successfully generating personalized thank you notes

#### Cache Clearing
- Had to clear Next.js cache (`.next` folder) and restart dev server
- Old compiled versions were using outdated model names
- Fresh server now correctly uses claude-3-haiku-20240307

### ‚ö†Ô∏è Known Issues
1. **Next.js 15 Async API Warnings** (not breaking, just warnings):
   - `params` should be awaited in API routes
   - `cookies()` should be awaited in server components
   - These are Next.js 15 requirements but app works fine without fixing

2. **Multiple Dev Servers Running**
   - Several background dev servers accumulated during development
   - Should kill old ones: 658883, 24bcc6, 0b6394, d5604d, 3d1ba3
   - Active server: faef7d

### üìù Next Steps / TODO
1. **Review & Approve Flow**
   - Implement the "Review & Approve" button functionality
   - Update note status from 'draft' to 'approved'
   - Allow editing of draft text before approval

2. **Handwriting Service Integration**
   - Research handwriting APIs (Handwrytten, Thankster, etc.)
   - Add API integration to send approved notes
   - Update note status to 'sent' after successful send
   - Store tracking information

3. **Dashboard Enhancements**
   - Add statistics (total deals, notes sent, etc.)
   - Show recent activity
   - Add filtering/search for notes

4. **Note Management**
   - Add ability to regenerate notes
   - Add manual editing of notes
   - Add preview of how note will look handwritten

5. **Error Handling**
   - Better error messages for users
   - Retry logic for failed transcriptions
   - Handle cases where audio transcription fails

6. **Code Cleanup**
   - Fix Next.js 15 async API warnings
   - Kill old dev servers
   - Remove unused OpenAI code if fully switching to Anthropic

### üéØ Current Working State
The application is **fully functional** for the core workflow:
1. Submit deal via public form ‚úì
2. Login to dashboard ‚úì
3. View all notes ‚úì
4. Generate AI-powered thank you notes ‚úì
5. **Next**: Review & Approve notes ‚Üí Send to handwriting service

### üí° Important Notes for Next Developer
- Always use `createServiceClient()` for operations that bypass RLS
- The public form uses service client to create records for any user_id
- Notes page is a server component - keep auth logic there
- When making changes to API routes, clear `.next` cache and restart dev server
- Anthropic API credits are at $10 - monitor usage
- AssemblyAI transcription costs money - be mindful of audio file sizes

### üêõ Debugging Tips
1. If seeing stale data, clear `.next` folder: `rm -rf .next`
2. Check dev server logs for API errors
3. Verify environment variables are loaded: check "Environments: .env.local" in startup logs
4. Use Supabase dashboard to inspect database directly
5. Check Anthropic console for API usage and credits

### üìû Contact
- User email: corbinbrandonwilliams@gmail.com
- Supabase Project: https://vszhsjpmlufjmmbswvov.supabase.co
